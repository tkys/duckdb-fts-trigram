# マルチアーキテクチャ対応に関する検討

## 現在のビルド環境

| 項目 | 結果 |
|--------|------|
| システムアーキテクチャ | ARM64 (Apple Silicon) |
| 拡張機能 | 8.7MB (ARM64 only) |
| ビルド方法 | CMake (duckdbサブモジュール内) |
| 対応CPU | ARM64のみ（x86_64非対応） |

---

## 課題点

### 現在の問題

- **他のCPUアーキテクチャで動作しない**
  - Intel MacやLinux x86_64などでは拡張が動かない
  - ユーザーが自分の環境でビルドする必要がある
  - デプロイが複雑化

- **DuckDBバージョン毎にビルドが必要**
  - v1.4, v1.5, v1.6 など各バージョンで再ビルド
  - ユーザー側でバージョン管理の負担

---

## 解決策の比較

### A. 拡張ページで配布（カスタムビルド）

| 項目 | メリット | デメリット |
|--------|--------|----------|
| ユーザー体験 | ⭐★★ | ユーザーが自分でビルド |
| ビルドの手間 | ⭐ | 初回のみ、その後はキャッシュ利用可能 |
| 更新の手間 | ⭐ | 最新の拡張を使いたいときに再ビルド |
| 信頼性 | ⭐ | 拡張は独立したバイナリ |
| 複雑さ | ⭐⭐ | ユーザーがビルド手順を理解する必要あり |

### B. upstream PR（Core拡張として統合）

| 項目 | メリット | デメリット |
|--------|--------|----------|
| ユーザー体験 | ⭐⭐⭐ | 公式DuckDBバイナリで利用可能 |
| メンテナンス | ⭐⭐⭐⭐ | DuckDB側で管理 |
| バージョン管理 | ⭐⭐⭐ | Coreリポジトリで統合 |
| テスト環境 | ⭐⭐⭐ | CI/CDで自動テスト |
| マルチアーキテクチャ | ⭐⭐ | GitHub Actionsで自動ビルド |
| 複雑さ | ⭐⭐⭐ | PRのレビューとマージが必要 |

### C. Universal Binary + カスタム拡張

| 項目 | メリット | デメリット |
|--------|--------|----------|
| ユーザー体験 | ⭐⭐ | 簡単なインストール |
| ビルドの簡素さ | ⭐ | CMakeで設定可能 |
| 複雑さ | ⭐⭐ | DuckDB側の管理、ユーザー側の拡張 |
| バージョン管理 | ⭐ | DuckDB本体と拡張の同期が必要 |

### D. GitHub ActionsでのマルチアーキテクチャCI

| 項目 | メリット | デメリット |
|--------|--------|----------|
| 自動化 | ⭐⭐⭐⭐ | 完全自動、人間の手間なし |
| マルチアーキテクチャ | ⭐⭐⭐ | ARM64, x86_64の両方を自動ビルド |
| テスト環境 | ⭐⭐⭐ | 各アーキテクチャで自動テスト |
| 開発者体験 | ⭐ | PRの履歴が追跡可能 |
| 複雑さ | ⭐ | GitHub Actionsの設定とメンテナンス |

---

## 推奨アプローチ

### 🎯 最善: upstream PR

**理由**:
1. **ユーザー体験の最大化**: 拡張が公式に統合されていれば、公式バイナリで使えます
2. **長期的なメンテナンス**: 将来のDuckDBバージョンアップデートで継続して動作
3. **コミュニティ**: 公式リポジトリで開発することで、他の開発者からフィードバックを受け取れる
4. **バージョン管理**: 1つのバージョンでDuckDB本体と拡張を管理
5. **マルチアーキテクチャ**: GitHub Actionsで自動CI、各アーキテクチャのバイナリを提供

**実装方法**:
```bash
# Step 1: upstream PRの作成
# - DuckDB公式リポジトリにPRを作成
# - 日本語対応の重要性を説明
# - 既存のissueがあれば確認

# Step 2: CI/CDの設定（必要な場合）
# - GitHub Actions workflowの追加
# - ARM64, x86_64のmatrixビルド設定

# Step 3: 公式拡張ページの更新（PRがマージされた後）
# - 「この拡張は次のバージョンに含まれる」案内を追加
```

### 📋 参考: 既存の拡張の例

**Community拡張**:
- [parquet](https://github.com/duckdb/parquet) - GitHub ActionsでCI
- [spatial](https://github.com/duckdb/spatial) - multi-architecture対応
- [httpfs](https://github.com/duckdb/httpfs) - ARM64/x86_64の両方

---

## DuckDBの拡張ビルドシステム

### CMakeベースのビルド

```makefile
# 既存の拡張ビルドシステム
ifeq ("${OSX_BUILD_ARCH}", "arm64")
	RUST_FLAGS=-DRust_CARGO_TARGET=aarch64-apple-darwin
else ifeq ("${OSX_BUILD_ARCH}", "x86_64")
	RUST_FLAGS=-DRust_CARGO_TARGET=x86_64-apple-darwin
```

**特徴**:
- ARM64とx86_64の両方に対応する設定が存在
- 各アーキテクチャ用に拡張を個別にビルド可能

### GitHub ActionsのMatrixビルド

```yaml
# .github/workflows/build.yml (例)
strategy:
  matrix:
    os: [macos-latest]
    arch: [arm64, x86_64]
```

**特徴**:
- 自動で複数のアーキテクチャを並列ビルド
- 各ビルドの成果物を自動でリリース

---

## 最終的な推奨

### 📋 upstream PRを作成してください

**メリット**:
- ユーザー体験が最善
- 長期的なメンテナンスが可能
- コミュニティが活発化できる
- マルチアーキテクチャ対応が自動化される

**手順**:
1. DuckDB公式リポジトリのIssueを確認
2. `trigram_unicode` featureの要望について既にissueが存在するか確認
3. PRの説明文書のドラフト作成
4. プルリクエストを作成

---

## 既知の課題

### バージョン互換性

```
DuckDB v1.4.0 + fts.duckdb_extension (ARM64) → ✅
DuckDB v1.5.0 + fts.duckdb_extension (ARM64) → ⚠️ 再ビルド必要
DuckDB v1.5.0 + fts.duckdb_extension (x86_64) → ❌ 動作不可（現在はARM64のみ）
```

### メンテナンスの継続

| 方法 | 問題 |
|------|--------|
| upstream PR | 新しいDuckDBバージョンが出たとき、拡張を再ビルド/更新する必要 |
| 拡張ページ | DuckDBの更新に追従して手動でビルドする必要 |
| カスタムビルド | ユーザーが自分でDuckDBと拡張をビルド・同期する必要 |

---

**結論**: upstream PRが最善の選択ですが、初期投資が大きい（PRレビュー、マージ待機間）です。

どのアプローチを希望しますか？

---

**作成日**: 2026-02-04
**目的**: マルチアーキテクチャ対応の検討と推奨
