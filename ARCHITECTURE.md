# DuckDB FTS拡張のアーキテクチャとデータフロー

## 概要

このドキュメントは、DuckDB FTS拡張に追加した`trigram_unicode`トークナイザーのアーキテクチャとデータフローを説明します。

---

## 1. 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                                                     │
│              DuckDB拡張機能                           │
│                                                     │
└─────────────────────────────────────────────────────────────────┘
                        │
                        │
                        ▼
┌────────────────┐     ▼     │  ▼     │  ▼     │     │  ▼     │
│  ユーザー      │     │        │        │        │        │
└────────────────┘
                        │
                        ▼
                        │
  ┌──────────────┐
  │  SQLクエリ    │
  └──────────────┘
                        │
                        ▼
                        │
┌─────────────────────────────┐
│  DuckDB Extension (fts.duckdb_extension)     │
└─────────────────────────────┘
                        │
                        ▼
                        │
┌─────────────────────────────┐
│         DuckDB本体                   │
│  • duckdb/include/ (APIヘッダー)    │
└─────────────────────────────┘
```

---

## 2. 拡張機能の構成

### 2.1 拡張機能の役割

```
┌──────────────────────────────────────────────────────────────────┐
│                                                      │
│     duckdb-fts/extension/fts/fts_extension.cpp     │
│                                                      │
│  • UTF-8文字分割関数                │
│    ├─ GenerateTrigramsUnicodeFunction   │
│    └─ UTF-8デコード処理            │
│  • trigram_unicodeトークナイザー          │
│  • generate_trigrams_unicode() スカラー関数  │
└──────────────────────────────────────────────────────────────────┘
```

### 2.2 拡張機能とDuckDBの関係性

```
┌──────────────────────────────────────────────────────────────────┐
│                                                      │
│            拡張機能                             │
│                                                      │
│  • DuckDB拡張メカニズム                    │
│    ├─ LOAD 'fts.duckdb_extension'        │
│    └─ 拡張ロード                       │
│                                                      │
│  • 使用するDuckDB API                      │
│    ├─ duckdb/include/duckdb.hpp          │
│    ├─ duckdb/common/vector_operations/*        │
│    ├─ duckdb/common/types/*               │
│    └─ duckdb/function/scalar_function/* │
└──────────────────────────────────────────────────────────────────┘
```

**重要な点**:
- 拡張機能はDuckDBのAPIを使用して実装
- `duckdb/include/` ヘッダーファイルは、拡張機能のビルド時のみ使用
- **本体コードとの「直接の関係性」はありません**
- 関係性があるとすれば、それは「DuckDBのバージョン互換性」です

---

## 3. データフロー

### 3.1 インデックス作成のフロー

```
┌──────────────────────────────────────────────────────────────────┐
│                                                      │
│              インデックス作成フロー                  │
│                                                      │
│  ユーザー                                      │
│      │                                       │
│      ▼                                       │
│      SQLクエリ                                    │
│   PRAGMA create_fts_index(                         │
│   'documents',                                    │
│   'id',                                          │
│   'title', 'text',                                 │
│   tokenizer='trigram_unicode')                    │
│                                                      │
│      ▼                                       │
│                                                      │
│   DuckDB拡張機能                                 │
│   1. strip_accents                                │
│   2. lower                                        │
│   3. 空白除去                                    │
│   4. UTF-8文字分割                                 │
│   5. trigram生成                                  │
│                                                      │
│      ▼                                       │
│                                                      │
│   インデックス構築                                 │
│   • fts_main_documents.dict (用語辞書)          │
│   • fts_main_documents.terms (転置インデックス)      │
│   • fts_main_documents.docs (ドキュメント)         │
│   • fts_main_documents.stats (統計情報)          │
└──────────────────────────────────────────────────────────────────┘
```

### 3.2 trigram_unicodeの処理詳細

```
入力: '東京タワー' (UTF-8文字列)

┌─────────────────────────────────────────────┐
│  1. strip_accents  │                    │
│    入力: '東京タワー'                 │
│    出力: '東京タワー'                 │
└─────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  2. lower          │                       │
│    入力: '東京タワー'                 │
│    出力: '東京タワー'                 │
└─────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  3. 空白除去      │                    │
│    入力: '東京タワー'                 │
│    出力: '東京タワー'                 │
└─────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│ 4. UTF-8文字分割 │                   │
│    入力: '東京タワー'                 │
│    └─ 文字オフセット: ['東', '京', 'タ', 'ワー'] │
└─────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────┐
│  5. trigram生成     │                   │
│    スライディングウィンドウ (n=3)           │
│    • [0:3] → '東京タ'                │
│    • [1:4] → '京タワ'                  │
│    • [2:5] → 'タワー'                   │
└─────────────────────────────────────────────┘
```

---

## 4. 検索のフロー

### 4.1 クエリ処理フロー

```
┌──────────────────────────────────────────────────────────────────┐
│                                                      │
│                検索クエリのフロー                  │
│                                                      │
│  ユーザー                                      │
│      │                                       │
│      ▼                                       │
│      SQLクエリ                                    │
│   SELECT id, title, text,                          │
│          fts_main_documents.match_bm25(id,  │
│          '東京') AS score                          │
│   FROM documents WHERE score IS NOT NULL                │
│                                                      │
│      ▼                                       │
│   DuckDB拡張機能 (fts_main_docs)             │
│   1. クエリをトークナイズ                │
│   2. トークナイズ → trigram化                   │
│   3. trigramマッチング                           │
│   4. BM25スコア計算                            │
│   5. 結果を返却                              │
│                                                      │
└──────────────────────────────────────────────────────────────────┘
```

### 4.2 trigramマッチングの詳細

```
クエリ: '東京'
クエリtrigram: ['東京', '京タ', 'タワー']

┌─────────────────────────────────────────────┐
│  ドキュメント: '東京タワー'                  │
│    ドキュメントtrigram: ['東京', '京タ', 'タワー'] │
│                                                      │
│  マッチング結果:                                    │
│    • '東京タ' → 3trigram中2個一致         │
│    • '京タワ' → 3trigram中1個一致         │
│    • 'タワー' → 3trigram中1個一致         │
│    • 合計: 4/9 trigram → BM25スコア高い   │
└─────────────────────────────────────────────┘
```

---

## 5. コードレベルの詳細

### 5.1 UTF-8文字分割関数

```cpp
// fts_extension.cpp
vector<idx_t> char_offsets;
char_offsets.push_back(0);

idx_t pos = 0;
while (pos < input_len) {
    unsigned char c = static_cast<unsigned char>(input_str[pos]);
    idx_t char_len = 1;

    // UTF-8デコード
    if (c < 0x80) {
        char_len = 1;              // ASCII: 1バイト
    } else if ((c & 0xE0) == 0xC0) {
        char_len = 2;              // ラテン拡張: 2バイト
    } else if ((c & 0xF0) == 0xE0) {
        char_len = 3;              // 日本語など: 3バイト
    } else if ((c & 0xF8) == 0xF0) {
        char_len = 4;              // 絵文字など: 4バイト
    }

    pos += char_len;
    char_offsets.push_back(pos);
}

idx_t num_chars = char_offsets.size() - 1;
idx_t num_trigrams = (num_chars >= 3) ? (num_chars - 2) : 0;

// スライディングウィンドウでtrigram生成
for (idx_t j = 0; j < num_trigrams; j++) {
    idx_t start = char_offsets[j];
    idx_t end = char_offsets[j + 3];
    idx_t trigram_len = end - start;
    child_data[current_offset + j] = StringVector::AddStringOrBlob(
        child_vector,
        input_str + start,
        trigram_len
    );
}
```

### 5.2 tokenizer統合

```cpp
// fts_indexing.cpp
bool is_trigram = (tokenizer == "trigram" || tokenizer == "trigram_unicode");

// trigram_unicodeモードの場合のマクロ生成
if (tokenizer == "trigram_unicode") {
    tokenize = "generate_trigrams_unicode(" + tokenize + ")";
} else {
    // wordモードの既存ロジック
    tokenize = "string_split_regex(...)";
}
```

---

## 6. ファイル構成

### 6.1 プロジェクトのファイル構造

```
duckdb-fts-trigram/
├── duckdb-fts/                    # サブモジュール（DuckDBの拡張テンプレート）
│   ├── extension/fts/
│   │   ├── fts_extension.cpp       # 拡張機能の実装コード
│   │   ├── fts_indexing.cpp       # インデックス作成ロジック
│   │   ├── include/                     # DuckDB APIヘッダー
│   │   └── ...                        # 他の必要なファイル
│   ├── build/release/
│   │   └── extension/fts/
│   │       └── fts.duckdb_extension  # ビルドされた拡張機能
│   ├── test/sql/fts/
│   │   └── test_trigram_unicode.test  # 日本語trigramテスト
│   └── README.md                         # FTS拡張のREADME
├── performance-test-plan.md            # 100万件パフォーマンステスト計画
└── BENCHMARK_SCRIPTS.md                # ベンチマーク・テストスクリプトの説明
```

---

## 7. 重要な制約と考慮事項

### 7.1 UTF-8デコードの制約

| 文字種 | UTF-8バイト数 | 例 | 注意点 |
|--------|---------------|----|----------|
| ASCII | 1バイト | 'a', '1', 'Z' | - |
| ラテン拡張 | 2バイト | 'é', 'ñ', 'ø' | アクセント除去後に処理 |
| ひらがな・カタカナ | 3バイト | 'あ', 'い', 'ア' | 日本語対応の核心 |
| 漢字（基本多言語面） | 3バイト | '東', '京', '道' | 日本語の主要な文字 |
| 絵文字など | 4バイト | '�', '🎉' | UTF-8サロゲートをサポート |

### 7.2 パフォーマンスの考慮事項

| 項目 | インデックス作成 | 検索 |
|--------|----------------|------|
| 1,000件 | 数秒〜数十秒 | 数ms〜数ms |
| 10,000件 | 数秒〜数分 | 数ms〜数十ms |
| 100,000件 | 数分〜数分 | 数ms〜数百ms |
| 1,000,000件 | 数分〜十分 | 数ms〜数百ms |

---

## 8. ビルドとデプロイ

### 8.1 ビルドプロセス

```
┌──────────────────────────────────────────────────────────────────┐
│                   ビルドプロセス                     │
│                                                      │
│  1. CMake設定                                     │
│ 2. 依存関係の解決                               │
│  3. 拡張機能のコンパイル (fts_extension.cpp)      │
│ 4. DuckDB本体のビルド                             │
│ 5. fts.duckdb_extensionの生成                │
└──────────────────────────────────────────────────────────────────┘
```

### 8.2 デプロイオプション

| オプション | メリット | デメリット |
|---------|----------|----------|
| **拡張ページで配布** | ユーザーが自分でビルドして使用 | ユーザー側の手間がかかる |
| **upstream PR（推奨）** | 公式DuckDBバイナリで使用可能 | PRレビューとマージに時間がかかる |
| **Dockerイメージ** | 分離、再現性高 | Docker知識が必要 |

---

## 9. まとめ

### 9.1 アーキテクチャのポイント

1. **拡張機能はDuckdb-ftsサブモジュール内で開発**
   - duckdb-ftsはDuckDB拡張のテンプレート
   - 拡張機能コードはこのサブモジュール内に含まれる

2. **拡張機能はDuckDBのAPIを使用**
   - `duckdb/include/` ヘッダーファイルを通じてDuckDBのAPIにアクセス
   - これはDuckDBの標準的な拡張開発手法

3. **関係性の意味**
   - 「拡張機能コードとDuckDB本体コードの関係性」という質問に対する答えは：
   - 「拡張機能はDuckDBの拡張メカニズムを通じてロードされる」
   - 「拡張機能はDuckDBのAPI（string, vectorなど）を使用して処理を行う」
   - 本体コードと「直接の関係性」（継承、包含など）はありません

4. **マルチアーキテクチャ対応**
   - 拡張機能はARM64とx86_64の両アーキテクチャで動作可能
   - 各DuckDBバージョン用に拡張をビルドする必要がある

---

**作成日**: 2026-02-04
**作成者**: Claude Sonnet 4.5
**目的**: DuckDB FTS拡張のアーキテクチャとデータフローの視覚的説明
